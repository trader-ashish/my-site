<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ü•á AshishTrader Breakout Radar Pro v3.0</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

<style>
:root {
  --bg-primary: #0a0e1a;
  --bg-secondary: #151922;
  --bg-card: #1a1f2e;
  --bg-card-hover: #1f2537;
  --color-primary: #00d4ff;
  --color-secondary: #7c3aed;
  --color-accent: #f97316;
  --color-success: #10b981;
  --color-danger: #ef4444;
  --color-warning: #f59e0b;
  --border-color: rgba(0, 212, 255, 0.15);
  --text-primary: #ffffff;
  --text-secondary: #94a3b8;
  --text-muted: #64748b;
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.4);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.5);
  --shadow-glow: 0 0 20px rgba(0, 212, 255, 0.3);
}

[data-theme="light"] {
  --bg-primary: #f8fafc;
  --bg-secondary: #ffffff;
  --bg-card: #ffffff;
  --bg-card-hover: #f1f5f9;
  --color-primary: #0284c7;
  --color-secondary: #7c3aed;
  --color-accent: #ea580c;
  --color-success: #059669;
  --color-danger: #dc2626;
  --color-warning: #d97706;
  --border-color: rgba(2, 132, 199, 0.2);
  --text-primary: #0f172a;
  --text-secondary: #475569;
  --text-muted: #94a3b8;
  --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.08);
  --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.12);
  --shadow-glow: 0 0 20px rgba(2, 132, 199, 0.2);
}

* { margin: 0; padding: 0; box-sizing: border-box; }

html, body {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  transition: background 0.3s ease, color 0.3s ease;
}

.app-container {
  max-width: 1920px;
  margin: 0 auto;
  padding: 20px;
}

/* Theme Toggle */
.theme-toggle {
  position: fixed;
  top: 20px;
  right: 20px;
  z-index: 1000;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 50px;
  padding: 10px 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  cursor: pointer;
  box-shadow: var(--shadow-md);
  transition: all 0.3s ease;
}

.theme-toggle:hover {
  transform: translateY(-2px);
  box-shadow: var(--shadow-lg);
}

.theme-icon {
  font-size: 20px;
  transition: transform 0.3s ease;
}

.theme-toggle:hover .theme-icon {
  transform: rotate(180deg);
}

/* Header */
.header {
  background: linear-gradient(135deg, var(--color-primary), var(--color-secondary));
  border-radius: 24px;
  padding: 30px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-glow);
  position: relative;
  overflow: hidden;
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(45deg, transparent, rgba(255,255,255,0.1), transparent);
  animation: shimmer 3s infinite;
}

@keyframes shimmer {
  0% { transform: translateX(-100%); }
  100% { transform: translateX(100%); }
}

.header-content {
  display: flex;
  align-items: center;
  justify-content: space-between;
  gap: 20px;
  position: relative;
  z-index: 1;
}

.header-left {
  display: flex;
  align-items: center;
  gap: 16px;
}

.logo {
  width: 60px;
  height: 60px;
  border-radius: 16px;
  box-shadow: var(--shadow-md);
  background: white;
  padding: 4px;
}

.header-title h1 {
  font-size: 28px;
  font-weight: 800;
  color: white;
  margin-bottom: 4px;
  letter-spacing: -0.5px;
}

.header-subtitle {
  font-size: 14px;
  color: rgba(255,255,255,0.9);
  font-weight: 500;
}

.live-indicator {
  display: flex;
  align-items: center;
  gap: 8px;
  background: rgba(255,255,255,0.2);
  padding: 8px 16px;
  border-radius: 20px;
  backdrop-filter: blur(10px);
}

.pulse-dot {
  width: 8px;
  height: 8px;
  background: #10b981;
  border-radius: 50%;
  animation: pulse 2s infinite;
}

@keyframes pulse {
  0%, 100% { opacity: 1; transform: scale(1); }
  50% { opacity: 0.5; transform: scale(1.2); }
}

.live-text {
  color: white;
  font-size: 13px;
  font-weight: 600;
}

/* Quick Stats */
.quick-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.stat-card {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 20px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 4px;
  height: 100%;
  background: var(--stat-color, var(--color-primary));
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
  border-color: var(--stat-color, var(--color-primary));
}

.stat-label {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.stat-value {
  font-size: 32px;
  font-weight: 800;
  color: var(--stat-color, var(--text-primary));
  line-height: 1;
  margin-bottom: 4px;
}

.stat-change {
  font-size: 13px;
  font-weight: 600;
  display: flex;
  align-items: center;
  gap: 4px;
}

.stat-change.positive { color: var(--color-success); }
.stat-change.negative { color: var(--color-danger); }

/* Top Movers Panel */
.panel {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
  transition: all 0.3s ease;
}

.panel:hover {
  box-shadow: var(--shadow-md);
}

.panel-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  cursor: pointer;
  user-select: none;
}

.panel-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.panel-icon {
  font-size: 22px;
}

.toggle-icon {
  font-size: 20px;
  color: var(--text-muted);
  transition: transform 0.3s ease;
}

.toggle-icon.expanded {
  transform: rotate(180deg);
}

.panel-content {
  max-height: 1000px;
  overflow: hidden;
  transition: max-height 0.4s ease, opacity 0.3s ease;
  opacity: 1;
}

.panel-content.collapsed {
  max-height: 0;
  opacity: 0;
}

.movers-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 20px;
}

.mover-section h3 {
  font-size: 16px;
  font-weight: 700;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid;
  display: flex;
  align-items: center;
  gap: 8px;
}

.mover-section.gainers h3 {
  color: var(--color-success);
  border-color: var(--color-success);
}

.mover-section.losers h3 {
  color: var(--color-danger);
  border-color: var(--color-danger);
}

.mover-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 14px;
  margin-bottom: 10px;
  background: var(--bg-secondary);
  border-radius: 12px;
  border-left: 4px solid;
  transition: all 0.3s ease;
  cursor: pointer;
}

.mover-item:hover {
  background: var(--bg-card-hover);
  transform: translateX(4px);
}

.mover-item.gainer {
  border-left-color: var(--color-success);
}

.mover-item.loser {
  border-left-color: var(--color-danger);
}

.mover-symbol {
  font-weight: 700;
  font-size: 14px;
  color: var(--text-primary);
}

.mover-change {
  font-weight: 700;
  font-size: 15px;
}

/* Badges */
.badges {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
}

.badge {
  flex: 1;
  min-width: 140px;
  padding: 16px 24px;
  border-radius: 16px;
  text-align: center;
  cursor: pointer;
  border: 2px solid transparent;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.badge::before {
  content: '';
  position: absolute;
  top: 0;
  left: -100%;
  width: 100%;
  height: 100%;
  background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
  transition: left 0.5s;
}

.badge:hover::before {
  left: 100%;
}

.badge:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.badge.active {
  border-color: currentColor;
  box-shadow: 0 0 30px currentColor;
  transform: scale(1.05);
}

.badge-pdh {
  background: linear-gradient(135deg, #10b981, #059669);
  color: white;
}

.badge-pdl {
  background: linear-gradient(135deg, #ef4444, #dc2626);
  color: white;
}

.badge-range {
  background: linear-gradient(135deg, #64748b, #475569);
  color: white;
}

.badge-label {
  font-size: 12px;
  font-weight: 600;
  opacity: 0.9;
  margin-bottom: 4px;
}

.badge-count {
  font-size: 28px;
  font-weight: 800;
}

/* Volume Surge */
.surge-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
  gap: 12px;
}

.surge-card {
  background: var(--bg-secondary);
  border: 1px solid rgba(245, 158, 11, 0.3);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}

.surge-card::before {
  content: '‚ö°';
  position: absolute;
  top: 8px;
  right: 8px;
  font-size: 20px;
  opacity: 0.2;
}

.surge-card:hover {
  transform: scale(1.05);
  border-color: var(--color-warning);
  box-shadow: 0 0 20px rgba(245, 158, 11, 0.3);
}

.surge-symbol {
  font-weight: 700;
  font-size: 15px;
  color: var(--text-primary);
  margin-bottom: 8px;
}

.surge-indicator {
  font-size: 13px;
  color: var(--color-warning);
  font-weight: 600;
}

/* Sentiment Panel */
.sentiment-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
  gap: 16px;
}

.sentiment-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 20px;
  text-align: center;
  transition: all 0.3s ease;
}

.sentiment-card:hover {
  transform: translateY(-4px);
  box-shadow: var(--shadow-md);
}

.sentiment-label {
  font-size: 12px;
  color: var(--text-muted);
  font-weight: 600;
  margin-bottom: 12px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.sentiment-value {
  font-size: 32px;
  font-weight: 800;
  line-height: 1;
}

.sentiment-value.bullish { color: var(--color-success); }
.sentiment-value.bearish { color: var(--color-danger); }

/* Sector Analysis */
.sector-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
  gap: 16px;
}

.sector-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 16px;
  padding: 20px;
  cursor: pointer;
  transition: all 0.3s ease;
  position: relative;
}

.sector-card:hover {
  transform: translateY(-4px);
  border-color: var(--color-primary);
  box-shadow: var(--shadow-md);
}

.sector-hot-badge {
  position: absolute;
  top: 12px;
  right: 12px;
  background: var(--color-warning);
  color: #000;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 11px;
  font-weight: 700;
  animation: bounce 2s infinite;
}

@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-4px); }
}

.sector-name {
  font-size: 14px;
  font-weight: 700;
  color: var(--text-primary);
  margin-bottom: 16px;
  padding-right: 60px;
}

.sector-stats-row {
  display: flex;
  justify-content: space-between;
  gap: 12px;
  margin-bottom: 12px;
}

.sector-mini-stat {
  flex: 1;
  text-align: center;
}

.sector-mini-label {
  font-size: 10px;
  color: var(--text-muted);
  margin-bottom: 4px;
  text-transform: uppercase;
}

.sector-mini-value {
  font-size: 18px;
  font-weight: 700;
}

.sector-bar {
  width: 100%;
  height: 8px;
  background: rgba(255,255,255,0.1);
  border-radius: 4px;
  position: relative;
  overflow: hidden;
}

.sector-bar-fill {
  height: 100%;
  position: absolute;
  border-radius: 4px;
  transition: width 0.3s ease;
}

.sector-bar-fill.bullish {
  background: var(--color-success);
  left: 0;
}

.sector-bar-fill.bearish {
  background: var(--color-danger);
  right: 0;
}

/* Search & Filters */
.controls {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  padding: 24px;
  margin-bottom: 24px;
  box-shadow: var(--shadow-sm);
}

.search-box {
  width: 100%;
  max-width: 600px;
  margin: 0 auto 20px;
}

.search-input {
  width: 100%;
  padding: 16px 24px 16px 48px;
  border-radius: 50px;
  border: 2px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 15px;
  font-weight: 500;
  transition: all 0.3s ease;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='20' height='20' viewBox='0 0 24 24' fill='none' stroke='%2364748b' stroke-width='2'%3E%3Ccircle cx='11' cy='11' r='8'%3E%3C/circle%3E%3Cpath d='m21 21-4.35-4.35'%3E%3C/path%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: 16px center;
}

.search-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1);
}

.filters-row {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
  align-items: center;
  justify-content: center;
}

.filter-select, .filter-button {
  padding: 12px 20px;
  border-radius: 12px;
  border: 1px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.3s ease;
}

.filter-select:hover, .filter-button:hover {
  border-color: var(--color-primary);
  transform: translateY(-2px);
}

.filter-select {
  min-width: 150px;
}

.filter-button {
  display: flex;
  align-items: center;
  gap: 8px;
}

.filter-button.primary {
  background: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
}

.filter-button.success {
  background: var(--color-success);
  color: white;
  border-color: var(--color-success);
}

.filter-button.danger {
  background: var(--color-danger);
  color: white;
  border-color: var(--color-danger);
}

.checkbox-label {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  border-radius: 12px;
  background: var(--bg-secondary);
  cursor: pointer;
  font-weight: 600;
  font-size: 14px;
  transition: all 0.3s ease;
}

.checkbox-label:hover {
  background: var(--bg-card-hover);
}

/* Watchlist Tabs */
.watchlist-tabs {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
  flex-wrap: wrap;
  align-items: center;
}

.watchlist-tab {
  padding: 12px 24px;
  border-radius: 12px;
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.watchlist-tab:hover {
  background: var(--bg-card-hover);
  transform: translateY(-2px);
}

.watchlist-tab.active {
  background: var(--color-primary);
  color: white;
  border-color: var(--color-primary);
  box-shadow: 0 0 20px rgba(0, 212, 255, 0.4);
}

/* Table */
.table-container {
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  overflow: hidden;
  box-shadow: var(--shadow-sm);
  margin-bottom: 24px;
}

.table-wrapper {
  overflow-x: auto;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

thead {
  background: var(--bg-secondary);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 16px 12px;
  text-align: center;
  font-size: 12px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  border-bottom: 2px solid var(--border-color);
  white-space: nowrap;
}

th.sortable {
  cursor: pointer;
  user-select: none;
}

th.sortable:hover {
  color: var(--color-primary);
}

tbody tr {
  border-bottom: 1px solid var(--border-color);
  transition: all 0.3s ease;
}

tbody tr:hover {
  background: var(--bg-card-hover);
}

tbody tr.row-pdh {
  background: rgba(16, 185, 129, 0.1);
  border-left: 4px solid var(--color-success);
}

tbody tr.row-pdl {
  background: rgba(239, 68, 68, 0.1);
  border-left: 4px solid var(--color-danger);
}

tbody tr.row-range {
  background: rgba(100, 116, 139, 0.05);
  border-left: 4px solid var(--text-muted);
}

td {
  padding: 16px 12px;
  color: var(--text-primary);
  white-space: nowrap;
}

.star-btn {
  background: none;
  border: none;
  font-size: 20px;
  cursor: pointer;
  transition: transform 0.3s ease;
}

.star-btn:hover {
  transform: scale(1.3);
}

.symbol-link {
  color: var(--color-primary);
  font-weight: 700;
  text-decoration: none;
  transition: all 0.3s ease;
}

.symbol-link:hover {
  color: var(--color-secondary);
  text-decoration: underline;
}

.positive {
  color: var(--color-success);
  font-weight: 700;
}

.negative {
  color: var(--color-danger);
  font-weight: 700;
}

.mini-chart {
  width: 80px;
  height: 30px;
}

/* Loading Skeleton */
.skeleton {
  background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-card-hover) 50%, var(--bg-secondary) 75%);
  background-size: 200% 100%;
  animation: loading 1.5s infinite;
  border-radius: 8px;
}

@keyframes loading {
  0% { background-position: 200% 0; }
  100% { background-position: -200% 0; }
}

.skeleton-row {
  height: 60px;
}

/* Footer */
.footer {
  margin-top: 40px;
  padding: 32px;
  text-align: center;
  background: var(--bg-card);
  border: 1px solid var(--border-color);
  border-radius: 20px;
  box-shadow: var(--shadow-sm);
}

.footer-title {
  font-size: 20px;
  font-weight: 800;
  color: var(--color-primary);
  margin-bottom: 8px;
}

.footer-subtitle {
  font-size: 14px;
  color: var(--text-secondary);
  margin-bottom: 16px;
}

.footer-links {
  display: flex;
  justify-content: center;
  gap: 24px;
  flex-wrap: wrap;
}

.footer-link {
  color: var(--text-secondary);
  text-decoration: none;
  font-size: 14px;
  transition: color 0.3s ease;
}

.footer-link:hover {
  color: var(--color-primary);
}

/* Modal */
.modal {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.8);
  backdrop-filter: blur(8px);
  z-index: 2000;
  justify-content: center;
  align-items: center;
  animation: fadeIn 0.3s;
}

.modal.active {
  display: flex;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-content {
  background: var(--bg-card);
  border: 2px solid var(--border-color);
  border-radius: 24px;
  padding: 32px;
  max-width: 900px;
  width: 90%;
  max-height: 85vh;
  overflow-y: auto;
  box-shadow: var(--shadow-lg);
  animation: slideUp 0.3s;
}

@keyframes slideUp {
  from { transform: translateY(50px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 24px;
  padding-bottom: 16px;
  border-bottom: 2px solid var(--border-color);
}

.modal-title {
  font-size: 24px;
  font-weight: 800;
  color: var(--color-primary);
  display: flex;
  align-items: center;
  gap: 12px;
}

.modal-close {
  background: var(--bg-secondary);
  border: 2px solid var(--border-color);
  color: var(--text-primary);
  font-size: 24px;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.3s ease;
}

.modal-close:hover {
  background: var(--color-danger);
  color: white;
  border-color: var(--color-danger);
  transform: rotate(90deg);
}

.sector-modal-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
  gap: 16px;
  margin-bottom: 24px;
}

.sector-modal-stat-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-color);
  border-radius: 12px;
  padding: 16px;
  text-align: center;
}

.sector-modal-stat-label {
  font-size: 11px;
  color: var(--text-muted);
  text-transform: uppercase;
  margin-bottom: 8px;
  font-weight: 600;
}

.sector-modal-stat-value {
  font-size: 28px;
  font-weight: 800;
  line-height: 1;
}

.sector-stocks-table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 16px;
}

.sector-stocks-table th {
  background: var(--bg-secondary);
  padding: 12px;
  text-align: center;
  font-size: 11px;
  font-weight: 700;
  color: var(--text-muted);
  text-transform: uppercase;
  border-bottom: 2px solid var(--border-color);
}

.sector-stocks-table td {
  padding: 12px;
  text-align: center;
  border-bottom: 1px solid var(--border-color);
}

.sector-stocks-table tbody tr:hover {
  background: var(--bg-card-hover);
}

.modal-input {
  width: 100%;
  padding: 14px 18px;
  margin-bottom: 16px;
  border-radius: 12px;
  border: 2px solid var(--border-color);
  background: var(--bg-secondary);
  color: var(--text-primary);
  font-size: 15px;
  transition: all 0.3s ease;
}

.modal-input:focus {
  outline: none;
  border-color: var(--color-primary);
  box-shadow: 0 0 0 4px rgba(0, 212, 255, 0.1);
}

.modal-footer {
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  margin-top: 24px;
}

.modal-btn {
  padding: 12px 24px;
  border-radius: 12px;
  border: none;
  font-weight: 700;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.modal-btn-primary {
  background: var(--color-primary);
  color: white;
}

.modal-btn-primary:hover {
  background: var(--color-secondary);
  transform: translateY(-2px);
  box-shadow: var(--shadow-md);
}

.modal-btn-secondary {
  background: var(--bg-secondary);
  color: var(--text-primary);
  border: 1px solid var(--border-color);
}

.modal-btn-secondary:hover {
  background: var(--bg-card-hover);
}

/* Responsive */
@media (max-width: 968px) {
  .movers-grid { grid-template-columns: 1fr; }
  .header-content { flex-direction: column; text-align: center; }
  .quick-stats { grid-template-columns: 1fr 1fr; }
}

@media (max-width: 640px) {
  .quick-stats { grid-template-columns: 1fr; }
  .badges { flex-direction: column; }
  .watchlist-tabs { flex-direction: column; width: 100%; }
  .watchlist-tab { width: 100%; }
  .filters-row { flex-direction: column; width: 100%; }
  .filter-select, .filter-button { width: 100%; }
}
</style>
</head>

<body>

<div class="theme-toggle" onclick="toggleTheme()">
  <span class="theme-icon" id="themeIcon">üåô</span>
  <span id="themeText">Dark</span>
</div>

<div class="app-container">

  <div class="header">
    <div class="header-content">
      <div class="header-left">
        <img class="logo" src="https://blogger.googleusercontent.com/img/a/AVvXsEilc79xbfyLKhXFpBE6YCM67UdnPE500pS7ZaIqcLWn3_SgwEjxgtfEMakpwUBuSZ7-211C9FzNrYqXo3ebIH6WK7XkNkPs5TBFZFyW46W-eB83zz2B8RLtOjflsDB8j1lBAGAIkIJyTsOLQ5SD__y3DFKvFJnc6mvGEeHpkAGn6IecSdNaaReouhtYISQ=s150" alt="Logo">
        <div class="header-title">
          <h1>ü•á AshishTrader Breakout Radar Pro</h1>
          <div class="header-subtitle">Advanced Intraday Scanner v3.0</div>
        </div>
      </div>
      <div class="live-indicator">
        <div class="pulse-dot"></div>
        <span class="live-text">LIVE</span>
      </div>
    </div>
  </div>

  <div class="quick-stats" id="quickStats">
    <div class="stat-card" style="--stat-color: var(--color-primary)">
      <div class="stat-label">Total Scanned</div>
      <div class="stat-value" id="totalScanned">0</div>
      <div class="stat-change">NSE Stocks</div>
    </div>
    <div class="stat-card" style="--stat-color: var(--color-success)">
      <div class="stat-label">Advances</div>
      <div class="stat-value" id="advances">0</div>
      <div class="stat-change positive" id="advPercent">0%</div>
    </div>
    <div class="stat-card" style="--stat-color: var(--color-danger)">
      <div class="stat-label">Declines</div>
      <div class="stat-value" id="declines">0</div>
      <div class="stat-change negative" id="decPercent">0%</div>
    </div>
    <div class="stat-card" style="--stat-color: var(--color-accent)">
      <div class="stat-label">Top Sector</div>
      <div class="stat-value" style="font-size: 20px" id="topSector">-</div>
      <div class="stat-change" id="topSectorChange">-</div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header" onclick="togglePanel('movers')">
      <div class="panel-title">
        <span class="panel-icon">üèÜ</span>
        Top Movers (5 Gainers & 5 Losers)
      </div>
      <span class="toggle-icon expanded" id="moversToggle">‚ñº</span>
    </div>
    <div class="panel-content" id="moversContent">
      <div class="movers-grid">
        <div class="mover-section gainers">
          <h3>üìà Top Gainers</h3>
          <div id="gainersList"></div>
        </div>
        <div class="mover-section losers">
          <h3>üìâ Top Losers</h3>
          <div id="losersList"></div>
        </div>
      </div>
    </div>
  </div>

  <div class="badges">
    <div class="badge badge-pdh" onclick="filterByBadge('PDH')" id="badgePDH">
      <div class="badge-label">PDH Breakout</div>
      <div class="badge-count" id="pdhCount">0</div>
    </div>
    <div class="badge badge-pdl" onclick="filterByBadge('PDL')" id="badgePDL">
      <div class="badge-label">PDL Breakdown</div>
      <div class="badge-count" id="pdlCount">0</div>
    </div>
    <div class="badge badge-range" onclick="filterByBadge('Range')" id="badgeRange">
      <div class="badge-label">In Range</div>
      <div class="badge-count" id="rangeCount">0</div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header" onclick="togglePanel('volume')">
      <div class="panel-title">
        <span class="panel-icon">‚ö°</span>
        Volume Surge Detector
      </div>
      <span class="toggle-icon expanded" id="volumeToggle">‚ñº</span>
    </div>
    <div class="panel-content" id="volumeContent">
      <div class="surge-grid" id="surgeGrid"></div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header">
      <div class="panel-title">
        <span class="panel-icon">üìä</span>
        Market Sentiment
      </div>
    </div>
    <div class="panel-content">
      <div class="sentiment-grid">
        <div class="sentiment-card">
          <div class="sentiment-label">Bullish</div>
          <div class="sentiment-value bullish" id="bullishCount">0</div>
        </div>
        <div class="sentiment-card">
          <div class="sentiment-label">Bearish</div>
          <div class="sentiment-value bearish" id="bearishCount">0</div>
        </div>
        <div class="sentiment-card">
          <div class="sentiment-label">Market Mood</div>
          <div class="sentiment-value" id="marketMood">-</div>
        </div>
        <div class="sentiment-card">
          <div class="sentiment-label">Avg Change</div>
          <div class="sentiment-value" id="avgChange">0%</div>
        </div>
      </div>
    </div>
  </div>

  <div class="panel">
    <div class="panel-header" onclick="togglePanel('sector')">
      <div class="panel-title">
        <span class="panel-icon">üìà</span>
        Sector Rotation Tracker
      </div>
      <span class="toggle-icon expanded" id="sectorToggle">‚ñº</span>
    </div>
    <div class="panel-content" id="sectorContent">
      <div class="sector-grid" id="sectorGrid"></div>
    </div>
  </div>

  <div class="watchlist-tabs">
    <div class="watchlist-tab active" onclick="switchWatchlist('all')" id="tabAll">All Stocks</div>
    <div class="watchlist-tab" onclick="switchWatchlist('favorites')" id="tabFavorites">‚≠ê Favorites</div>
    <div class="watchlist-tab" onclick="switchWatchlist('watchlist1')" id="tabWatchlist1">Watchlist 1</div>
    <div class="watchlist-tab" onclick="switchWatchlist('watchlist2')" id="tabWatchlist2">Watchlist 2</div>
    <button class="filter-button success" onclick="openAddWatchlistModal()">
      <span>‚ûï</span> Add Watchlist
    </button>
  </div>

  <div class="controls">
    <div class="search-box">
      <input type="text" class="search-input" id="searchInput" placeholder="Search stocks by symbol or company name...">
    </div>
    
    <div class="filters-row">
      <select class="filter-select" id="sectorFilter">
        <option value="ALL">All Sectors</option>
      </select>
      
      <select class="filter-select" id="statusFilter">
        <option value="ALL">All Status</option>
        <option value="PDH">PDH Only</option>
        <option value="PDL">PDL Only</option>
        <option value="Range">Range Only</option>
      </select>
      
      <select class="filter-select" id="percentFilter">
        <option value="ALL">All %</option>
        <option value="POS">PDH + % > 0</option>
        <option value="NEG">PDL + % < 0</option>
      </select>
      
      <select class="filter-select" id="volumeFilter">
        <option value="ALL">All Volume</option>
        <option value="HIGH">High Volume</option>
      </select>
      
      <label class="checkbox-label">
        <input type="checkbox" id="autoRefresh">
        Auto Refresh
      </label>
      
      <button class="filter-button primary" onclick="refreshData()">
        <span>üîÑ</span> Refresh
      </button>
      
      <button class="filter-button success" onclick="downloadCSV()">
        <span>‚¨á</span> Export CSV
      </button>
      
      <button class="filter-button danger" onclick="generatePDF()">
        <span>üìÑ</span> PDF Report
      </button>
    </div>
  </div>

  <div class="table-container">
    <div class="table-wrapper">
      <table>
        <thead>
          <tr>
            <th>‚≠ê</th>
            <th>Symbol</th>
            <th>Company</th>
            <th>Sector</th>
            <th>LTP</th>
            <th>Prev Close</th>
            <th>Prev High</th>
            <th>Prev Low</th>
            <th>Status</th>
            <th>Volume</th>
            <th class="sortable" onclick="sortTable()">Change % ‚áÖ</th>
            <th>Chart</th>
            <th>Momentum</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <tr class="skeleton-row"><td colspan="13"><div class="skeleton" style="height: 40px"></div></td></tr>
          <tr class="skeleton-row"><td colspan="13"><div class="skeleton" style="height: 40px"></div></td></tr>
          <tr class="skeleton-row"><td colspan="13"><div class="skeleton" style="height: 40px"></div></td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <div class="footer-title">Ashish Mishra</div>
    <div class="footer-subtitle">Full-Time Trader & Market Strategist</div>
    <div class="footer-links">
      <a href="https://www.ashishtrader.co.in" target="_blank" class="footer-link">üåê www.ashishtrader.co.in</a>
      <a href="mailto:ashishmishraahc@gmail.com" class="footer-link">‚úâÔ∏è ashishmishraahc@gmail.com</a>
    </div>
  </div>

</div>

<div class="modal" id="addWatchlistModal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <div class="modal-title">
        <span>‚ûï</span>
        <span>Create New Watchlist</span>
      </div>
      <button class="modal-close" onclick="closeAddWatchlistModal()">‚úï</button>
    </div>
    
    <div>
      <label style="display: block; font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 8px;">
        Watchlist Name
      </label>
      <input 
        type="text" 
        class="modal-input" 
        id="newWatchlistName" 
        placeholder="e.g., My Tech Stocks, Swing Trading, etc."
        maxlength="20"
      >
      <div style="font-size: 12px; color: var(--text-muted); margin-top: 8px;">
        üí° Tip: Choose a meaningful name to organize your stocks better
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeAddWatchlistModal()">Cancel</button>
      <button class="modal-btn modal-btn-primary" onclick="createNewWatchlist()">
        <span>‚úì</span> Create Watchlist
      </button>
    </div>
  </div>
</div>

<div class="modal" id="addToWatchlistModal">
  <div class="modal-content" style="max-width: 500px;">
    <div class="modal-header">
      <div class="modal-title">
        <span>üìã</span>
        <span>Add to Watchlist</span>
      </div>
      <button class="modal-close" onclick="closeAddToWatchlistModal()">‚úï</button>
    </div>
    
    <div>
      <div style="font-size: 14px; font-weight: 600; color: var(--text-secondary); margin-bottom: 16px;">
        Select Watchlist for: <span style="color: var(--color-primary);" id="selectedStockSymbol"></span>
      </div>
      
      <div id="watchlistSelectionList" style="display: flex; flex-direction: column; gap: 12px;">
        <!-- Watchlist options will be populated here -->
      </div>
    </div>
    
    <div class="modal-footer">
      <button class="modal-btn modal-btn-secondary" onclick="closeAddToWatchlistModal()">Close</button>
    </div>
  </div>
</div>

<div class="modal" id="sectorModal">
  <div class="modal-content">
    <div class="modal-header">
      <div class="modal-title" id="sectorModalTitle">
        <span>üìä</span>
        <span>Sector Details</span>
      </div>
      <button class="modal-close" onclick="closeSectorModal()">‚úï</button>
    </div>
    
    <div class="sector-modal-stats" id="sectorModalStats"></div>
    
    <div style="margin-top: 24px;">
      <h3 style="font-size: 16px; font-weight: 700; color: var(--text-primary); margin-bottom: 16px;">
        üìà All Stocks in This Sector
      </h3>
      <table class="sector-stocks-table">
        <thead>
          <tr>
            <th>Symbol</th>
            <th>Company</th>
            <th>LTP</th>
            <th>Status</th>
            <th>Change %</th>
            <th>Volume</th>
          </tr>
        </thead>
        <tbody id="sectorModalTableBody"></tbody>
      </table>
    </div>
  </div>
</div>

</div>

<script>
// State Management (No localStorage, all in-memory)
let sheetData = [];
let currentFiltered = [];
let sortOrder = "desc";
let currentWatchlist = 'all';
let favorites = [];
let watchlists = { watchlist1: [], watchlist2: [] };
let customWatchlists = {}; // For user-created watchlists
let watchlistCounter = 3; // Start from 3 since we have watchlist1 and watchlist2
let activeBadge = null;
let refreshInterval = null;
let prevSectorData = {};
let sectorRotation = {};
let selectedStockForWatchlist = null;

// Fetch Data
async function fetchData() {
  try {
    const response = await fetch("https://opensheet.elk.sh/1WzEu3UcFHyxcRvTZjUYanyaGHx6hjJS_pWwUFM8qY_Q/Sheet1");
    const data = await response.json();
    
    // Debug: Console mein column names print karenge
    if(data && data.length > 0) {
      console.log("Available columns:", Object.keys(data[0]));
    }
    
    sheetData = data;
    
    populateSectors();
    updateAllStats();
    applyFilters();
  } catch (error) {
    console.error('Error fetching data:', error);
    document.getElementById('tableBody').innerHTML = '<tr><td colspan="13" style="text-align:center; padding: 40px; color: var(--color-danger)">‚ö†Ô∏è Error loading data. Please try again.</td></tr>';
  }
}

// Theme Toggle
function toggleTheme() {
  const html = document.documentElement;
  const icon = document.getElementById('themeIcon');
  const text = document.getElementById('themeText');
  
  if (html.getAttribute('data-theme') === 'light') {
    html.removeAttribute('data-theme');
    icon.innerText = 'üåô';
    text.innerText = 'Dark';
  } else {
    html.setAttribute('data-theme', 'light');
    icon.innerText = '‚òÄÔ∏è';
    text.innerText = 'Light';
  }
}

// Panel Toggle
function togglePanel(panelName) {
  const content = document.getElementById(panelName + 'Content');
  const toggle = document.getElementById(panelName + 'Toggle');
  
  content.classList.toggle('collapsed');
  toggle.classList.toggle('expanded');
}

// Populate Sectors
function populateSectors() {
  const select = document.getElementById('sectorFilter');
  const currentValue = select.value;
  
  const sectors = [...new Set(sheetData.map(r => r["Sector"]).filter(Boolean))].sort();
  
  select.innerHTML = '<option value="ALL">All Sectors</option>';
  sectors.forEach(sector => {
    const option = document.createElement('option');
    option.value = sector;
    option.textContent = sector;
    select.appendChild(option);
  });
  
  select.value = currentValue;
}

// Update All Stats
function updateAllStats() {
  updateQuickStats();
  updateBadgeCounts();
  updateTopMovers();
  updateVolumeSurge();
  updateSentiment();
  updateSectorAnalysis();
}

// Update Quick Stats
function updateQuickStats() {
  const total = sheetData.length;
  const advances = sheetData.filter(r => parseFloat(r["Changepct"]) > 0).length;
  const declines = sheetData.filter(r => parseFloat(r["Changepct"]) < 0).length;
  
  document.getElementById('totalScanned').innerText = total;
  document.getElementById('advances').innerText = advances;
  document.getElementById('declines').innerText = declines;
  document.getElementById('advPercent').innerText = total > 0 ? ((advances/total)*100).toFixed(1) + '%' : '0%';
  document.getElementById('decPercent').innerText = total > 0 ? ((declines/total)*100).toFixed(1) + '%' : '0%';
  
  // Top Sector
  const sectorMap = {};
  sheetData.forEach(r => {
    if (r["Sector"] && parseFloat(r["Changepct"]) > 0) {
      sectorMap[r["Sector"]] = (sectorMap[r["Sector"]] || 0) + 1;
    }
  });
  
  const topSec = Object.keys(sectorMap).reduce((a, b) => sectorMap[a] > sectorMap[b] ? a : b, "-");
  document.getElementById('topSector').innerText = topSec;
  document.getElementById('topSectorChange').innerText = topSec !== "-" ? `${sectorMap[topSec]} stocks rising` : '-';
}

// Update Badge Counts
function updateBadgeCounts() {
  document.getElementById('pdhCount').innerText = sheetData.filter(r => r["PDH/PDL"] === "PDH").length;
  document.getElementById('pdlCount').innerText = sheetData.filter(r => r["PDH/PDL"] === "PDL").length;
  document.getElementById('rangeCount').innerText = sheetData.filter(r => r["PDH/PDL"] === "Range").length;
}

// Update Top Movers
function updateTopMovers() {
  const validData = sheetData.filter(r => r["Changepct"] && !isNaN(parseFloat(r["Changepct"])));
  const sorted = [...validData].sort((a, b) => parseFloat(b["Changepct"]) - parseFloat(a["Changepct"]));
  
  const gainers = sorted.slice(0, 5);
  const losers = sorted.slice(-5).reverse();
  
  document.getElementById('gainersList').innerHTML = gainers.map(r => `
    <div class="mover-item gainer">
      <span class="mover-symbol">${r["Symbol"]}</span>
      <span class="mover-change" style="color: var(--color-success)">${r["Changepct"]}%</span>
    </div>
  `).join('');
  
  document.getElementById('losersList').innerHTML = losers.map(r => `
    <div class="mover-item loser">
      <span class="mover-symbol">${r["Symbol"]}</span>
      <span class="mover-change" style="color: var(--color-danger)">${r["Changepct"]}%</span>
    </div>
  `).join('');
}

// Update Volume Surge
function updateVolumeSurge() {
  const validVol = sheetData.filter(r => r["Volume"] && !isNaN(parseFloat(r["Volume"])));
  const avgVol = validVol.reduce((sum, r) => sum + parseFloat(r["Volume"]), 0) / validVol.length;
  
  const surgeStocks = sheetData
    .filter(r => parseFloat(r["Volume"]) > avgVol * 2)
    .slice(0, 12);
  
  document.getElementById('surgeGrid').innerHTML = surgeStocks.map(r => {
    const ratio = (parseFloat(r["Volume"]) / avgVol).toFixed(1);
    return `
      <div class="surge-card">
        <div class="surge-symbol">${r["Symbol"]}</div>
        <div class="surge-indicator">${ratio}x Average</div>
      </div>
    `;
  }).join('');
}

// Update Sentiment
function updateSentiment() {
  const validData = sheetData.filter(r => r["Changepct"] && !isNaN(parseFloat(r["Changepct"])));
  const bullish = validData.filter(r => parseFloat(r["Changepct"]) > 0).length;
  const bearish = validData.filter(r => parseFloat(r["Changepct"]) < 0).length;
  
  document.getElementById('bullishCount').innerText = bullish;
  document.getElementById('bearishCount').innerText = bearish;
  
  const total = bullish + bearish;
  const bullishPercent = total > 0 ? (bullish / total * 100) : 0;
  
  let mood = "Neutral üòê";
  let moodClass = "";
  
  if (bullishPercent >= 65) {
    mood = "Bullish üöÄ";
    moodClass = "bullish";
  } else if (bullishPercent <= 35) {
    mood = "Bearish üìâ";
    moodClass = "bearish";
  }
  
  document.getElementById('marketMood').innerText = mood;
  document.getElementById('marketMood').className = "sentiment-value " + moodClass;
  
  const avgChg = validData.length > 0 
    ? (validData.reduce((sum, r) => sum + parseFloat(r["Changepct"]), 0) / validData.length).toFixed(2)
    : 0;
  
  document.getElementById('avgChange').innerText = avgChg + "%";
  document.getElementById('avgChange').className = "sentiment-value " + (avgChg >= 0 ? "bullish" : "bearish");
}

// Update Sector Analysis
function updateSectorAnalysis() {
  const sectorData = {};
  
  sheetData.forEach(row => {
    const sector = row["Sector"] || "Unknown";
    const change = parseFloat(row["Changepct"]);
    
    if (!sectorData[sector]) {
      sectorData[sector] = { total: 0, bullish: 0, bearish: 0, sum: 0 };
    }
    
    sectorData[sector].total++;
    
    if (!isNaN(change)) {
      sectorData[sector].sum += change;
      if (change > 0) sectorData[sector].bullish++;
      else if (change < 0) sectorData[sector].bearish++;
    }
  });
  
  // Calculate averages and detect rotation
  Object.keys(sectorData).forEach(sector => {
    const data = sectorData[sector];
    data.avgChange = data.total > 0 ? (data.sum / data.total).toFixed(2) : 0;
    
    if (prevSectorData[sector]) {
      const prevAvg = parseFloat(prevSectorData[sector].avgChange);
      const currAvg = parseFloat(data.avgChange);
      sectorRotation[sector] = (currAvg - prevAvg > 1) ? 'HOT' : '';
    }
  });
  
  prevSectorData = JSON.parse(JSON.stringify(sectorData));
  
  const grid = document.getElementById('sectorGrid');
  grid.innerHTML = Object.keys(sectorData)
    .sort((a, b) => parseFloat(sectorData[b].avgChange) - parseFloat(sectorData[a].avgChange))
    .map(sector => {
      const data = sectorData[sector];
      const bullishPercent = data.total > 0 ? (data.bullish / data.total * 100) : 0;
      const bearishPercent = data.total > 0 ? (data.bearish / data.total * 100) : 0;
      
      return `
        <div class="sector-card" onclick="filterBySector('${sector}')">
          ${sectorRotation[sector] === 'HOT' ? '<div class="sector-hot-badge">üî• HOT</div>' : ''}
          <div class="sector-name">${sector}</div>
          <div class="sector-stats-row">
            <div class="sector-mini-stat">
              <div class="sector-mini-label">Bullish</div>
              <div class="sector-mini-value" style="color: var(--color-success)">${data.bullish}</div>
            </div>
            <div class="sector-mini-stat">
              <div class="sector-mini-label">Bearish</div>
              <div class="sector-mini-value" style="color: var(--color-danger)">${data.bearish}</div>
            </div>
            <div class="sector-mini-stat">
              <div class="sector-mini-label">Avg</div>
              <div class="sector-mini-value" style="color: ${data.avgChange >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}">${data.avgChange}%</div>
            </div>
          </div>
          <div class="sector-bar">
            <div class="sector-bar-fill bullish" style="width: ${bullishPercent}%"></div>
            <div class="sector-bar-fill bearish" style="width: ${bearishPercent}%"></div>
          </div>
        </div>
      `;
    }).join('');
}

// Filter by Sector
function filterBySector(sector) {
  openSectorModal(sector);
}

// Open Sector Modal
function openSectorModal(sector) {
  const modal = document.getElementById('sectorModal');
  const sectorStocks = sheetData.filter(r => r["Sector"] === sector);
  
  // Calculate sector stats
  const total = sectorStocks.length;
  const bullish = sectorStocks.filter(r => parseFloat(r["Changepct"]) > 0).length;
  const bearish = sectorStocks.filter(r => parseFloat(r["Changepct"]) < 0).length;
  const neutral = total - bullish - bearish;
  
  const avgChange = sectorStocks.length > 0
    ? (sectorStocks.reduce((sum, r) => sum + (parseFloat(r["Changepct"]) || 0), 0) / total).toFixed(2)
    : 0;
  
  const totalVolume = sectorStocks.reduce((sum, r) => sum + (parseFloat(r["Volume"]) || 0), 0);
  const volumeText = totalVolume >= 1000000000 
    ? (totalVolume / 1000000000).toFixed(2) + "B"
    : totalVolume >= 1000000 
    ? (totalVolume / 1000000).toFixed(2) + "M"
    : (totalVolume / 1000).toFixed(0) + "K";
  
  // Find top gainer and loser
  const sorted = [...sectorStocks].sort((a, b) => parseFloat(b["Changepct"]) - parseFloat(a["Changepct"]));
  const topGainer = sorted[0];
  const topLoser = sorted[sorted.length - 1];
  
  // Update modal title
  document.getElementById('sectorModalTitle').innerHTML = `
    <span>üìä</span>
    <span>${sector}</span>
  `;
  
  // Update stats
  document.getElementById('sectorModalStats').innerHTML = `
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Total Stocks</div>
      <div class="sector-modal-stat-value" style="color: var(--color-primary)">${total}</div>
    </div>
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Bullish</div>
      <div class="sector-modal-stat-value" style="color: var(--color-success)">${bullish}</div>
    </div>
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Bearish</div>
      <div class="sector-modal-stat-value" style="color: var(--color-danger)">${bearish}</div>
    </div>
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Neutral</div>
      <div class="sector-modal-stat-value" style="color: var(--text-muted)">${neutral}</div>
    </div>
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Avg Change</div>
      <div class="sector-modal-stat-value" style="color: ${avgChange >= 0 ? 'var(--color-success)' : 'var(--color-danger)'}">${avgChange}%</div>
    </div>
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Total Volume</div>
      <div class="sector-modal-stat-value" style="color: var(--color-warning); font-size: 20px">${volumeText}</div>
    </div>
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Top Gainer</div>
      <div class="sector-modal-stat-value" style="color: var(--color-success); font-size: 16px">${topGainer ? topGainer["Symbol"] : '-'}</div>
      <div style="font-size: 12px; color: var(--color-success); margin-top: 4px;">${topGainer ? topGainer["Changepct"] + '%' : ''}</div>
    </div>
    <div class="sector-modal-stat-card">
      <div class="sector-modal-stat-label">Top Loser</div>
      <div class="sector-modal-stat-value" style="color: var(--color-danger); font-size: 16px">${topLoser ? topLoser["Symbol"] : '-'}</div>
      <div style="font-size: 12px; color: var(--color-danger); margin-top: 4px;">${topLoser ? topLoser["Changepct"] + '%' : ''}</div>
    </div>
  `;
  
  // Update table
  const tbody = document.getElementById('sectorModalTableBody');
  tbody.innerHTML = sectorStocks
    .sort((a, b) => parseFloat(b["Changepct"]) - parseFloat(a["Changepct"]))
    .map(r => {
      const change = parseFloat(r["Changepct"]);
      const changeClass = isNaN(change) ? "" : change >= 0 ? "positive" : "negative";
      const volume = parseFloat(r["Volume"]) || 0;
      const volText = volume >= 1000000 ? (volume/1000000).toFixed(2) + "M" : (volume/1000).toFixed(0) + "K";
      
      return `
        <tr>
          <td>
            <a href="https://www.tradingview.com/chart/?symbol=NSE:${r["Symbol"]}" target="_blank" class="symbol-link">
              ${r["Symbol"]}
            </a>
          </td>
          <td style="text-align: left; padding-left: 12px;">${r["Company Name"] || "-"}</td>
          <td style="font-weight: 600;">${r["LTP"] || "-"}</td>
          <td style="font-weight: 700;">${r["PDH/PDL"] || "-"}</td>
          <td class="${changeClass}" style="font-weight: 700;">${isNaN(change) ? "-" : change + "%"}</td>
          <td>${volText}</td>
        </tr>
      `;
    }).join('');
  
  modal.classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Close Sector Modal
function closeSectorModal() {
  document.getElementById('sectorModal').classList.remove('active');
  document.body.style.overflow = 'auto';
}

// Close modal on outside click
document.addEventListener('click', (e) => {
  const modal = document.getElementById('sectorModal');
  if (e.target === modal) {
    closeSectorModal();
  }
});

// Filter by Badge
function filterByBadge(status) {
  const badges = ['PDH', 'PDL', 'Range'];
  badges.forEach(b => document.getElementById('badge' + b).classList.remove('active'));
  
  if (activeBadge === status) {
    activeBadge = null;
    document.getElementById('statusFilter').value = 'ALL';
  } else {
    activeBadge = status;
    document.getElementById('badge' + status).classList.add('active');
    document.getElementById('statusFilter').value = status;
  }
  
  applyFilters();
}

// Switch Watchlist
function switchWatchlist(name) {
  currentWatchlist = name;
  document.querySelectorAll('.watchlist-tab').forEach(t => t.classList.remove('active'));
  
  // Handle both default and custom watchlists
  const tabId = 'tab' + name.charAt(0).toUpperCase() + name.slice(1);
  const tab = document.getElementById(tabId) || document.querySelector(`[data-watchlist="${name}"]`);
  if(tab) tab.classList.add('active');
  
  applyFilters();
}

// Toggle Favorite
function toggleFavorite(symbol) {
  const idx = favorites.indexOf(symbol);
  if (idx > -1) {
    favorites.splice(idx, 1);
  } else {
    favorites.push(symbol);
  }
  applyFilters();
}

// Open Add Watchlist Modal
function openAddWatchlistModal() {
  document.getElementById('addWatchlistModal').classList.add('active');
  document.getElementById('newWatchlistName').value = '';
  document.body.style.overflow = 'hidden';
}

// Close Add Watchlist Modal
function closeAddWatchlistModal() {
  document.getElementById('addWatchlistModal').classList.remove('active');
  document.body.style.overflow = 'auto';
}

// Create New Watchlist
function createNewWatchlist() {
  const nameInput = document.getElementById('newWatchlistName');
  const name = nameInput.value.trim();
  
  if (!name) {
    alert('‚ö†Ô∏è Please enter a watchlist name');
    return;
  }
  
  // Check if name already exists
  const allWatchlists = {...watchlists, ...customWatchlists};
  if (allWatchlists[name.toLowerCase()]) {
    alert('‚ö†Ô∏è A watchlist with this name already exists');
    return;
  }
  
  // Create unique ID
  const watchlistId = 'custom_' + watchlistCounter++;
  customWatchlists[watchlistId] = {
    name: name,
    stocks: []
  };
  
  // Add tab
  const tabsContainer = document.querySelector('.watchlist-tabs');
  const addButton = tabsContainer.querySelector('.filter-button');
  
  const newTab = document.createElement('div');
  newTab.className = 'watchlist-tab';
  newTab.setAttribute('data-watchlist', watchlistId);
  newTab.innerHTML = `
    ${name}
    <span onclick="deleteWatchlist('${watchlistId}', event)" 
          style="margin-left: 8px; color: var(--color-danger); cursor: pointer; font-size: 16px;"
          title="Delete watchlist">
      ‚úï
    </span>
  `;
  newTab.onclick = () => switchWatchlist(watchlistId);
  
  tabsContainer.insertBefore(newTab, addButton);
  
  closeAddWatchlistModal();
  
  // Show success message
  showNotification(`‚úÖ Watchlist "${name}" created successfully!`);
}

// Delete Watchlist
function deleteWatchlist(watchlistId, event) {
  event.stopPropagation();
  
  const watchlist = customWatchlists[watchlistId];
  if (!watchlist) return;
  
  if (confirm(`Are you sure you want to delete "${watchlist.name}"?`)) {
    delete customWatchlists[watchlistId];
    
    // Remove tab
    const tab = document.querySelector(`[data-watchlist="${watchlistId}"]`);
    if (tab) tab.remove();
    
    // If currently viewing this watchlist, switch to 'all'
    if (currentWatchlist === watchlistId) {
      switchWatchlist('all');
    }
    
    showNotification(`üóëÔ∏è Watchlist "${watchlist.name}" deleted`);
  }
}

// Open Add to Watchlist Modal
function openAddToWatchlistModal(symbol) {
  selectedStockForWatchlist = symbol;
  document.getElementById('selectedStockSymbol').innerText = symbol;
  
  // Populate watchlist options
  const container = document.getElementById('watchlistSelectionList');
  
  // Combine default and custom watchlists
  const allWatchlistsHtml = [];
  
  // Default watchlists
  ['watchlist1', 'watchlist2'].forEach(id => {
    const stocks = watchlists[id] || [];
    const isInWatchlist = stocks.includes(symbol);
    allWatchlistsHtml.push(`
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
        <div>
          <div style="font-weight: 600; color: var(--text-primary);">${id === 'watchlist1' ? 'Watchlist 1' : 'Watchlist 2'}</div>
          <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${stocks.length} stocks</div>
        </div>
        <button 
          class="modal-btn ${isInWatchlist ? 'modal-btn-secondary' : 'modal-btn-primary'}"
          onclick="${isInWatchlist ? `removeFromWatchlist('${symbol}', '${id}')` : `addToWatchlist('${symbol}', '${id}')`}"
          style="padding: 8px 16px; font-size: 13px;">
          ${isInWatchlist ? '‚úì Added' : '+ Add'}
        </button>
      </div>
    `);
  });
  
  // Custom watchlists
  Object.keys(customWatchlists).forEach(id => {
    const wl = customWatchlists[id];
    const isInWatchlist = wl.stocks.includes(symbol);
    allWatchlistsHtml.push(`
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 14px; background: var(--bg-secondary); border-radius: 12px; border: 1px solid var(--border-color);">
        <div>
          <div style="font-weight: 600; color: var(--text-primary);">${wl.name}</div>
          <div style="font-size: 12px; color: var(--text-muted); margin-top: 4px;">${wl.stocks.length} stocks</div>
        </div>
        <button 
          class="modal-btn ${isInWatchlist ? 'modal-btn-secondary' : 'modal-btn-primary'}"
          onclick="${isInWatchlist ? `removeFromCustomWatchlist('${symbol}', '${id}')` : `addToCustomWatchlist('${symbol}', '${id}')`}"
          style="padding: 8px 16px; font-size: 13px;">
          ${isInWatchlist ? '‚úì Added' : '+ Add'}
        </button>
      </div>
    `);
  });
  
  container.innerHTML = allWatchlistsHtml.join('');
  
  document.getElementById('addToWatchlistModal').classList.add('active');
  document.body.style.overflow = 'hidden';
}

// Close Add to Watchlist Modal
function closeAddToWatchlistModal() {
  document.getElementById('addToWatchlistModal').classList.remove('active');
  document.body.style.overflow = 'auto';
}

// Add to Default Watchlist
function addToWatchlist(symbol, watchlistId) {
  if (!watchlists[watchlistId]) {
    watchlists[watchlistId] = [];
  }
  
  if (!watchlists[watchlistId].includes(symbol)) {
    watchlists[watchlistId].push(symbol);
    showNotification(`‚úÖ ${symbol} added to ${watchlistId === 'watchlist1' ? 'Watchlist 1' : 'Watchlist 2'}`);
    openAddToWatchlistModal(symbol); // Refresh the modal
  }
}

// Remove from Default Watchlist
function removeFromWatchlist(symbol, watchlistId) {
  if (watchlists[watchlistId]) {
    const idx = watchlists[watchlistId].indexOf(symbol);
    if (idx > -1) {
      watchlists[watchlistId].splice(idx, 1);
      showNotification(`üóëÔ∏è ${symbol} removed from ${watchlistId === 'watchlist1' ? 'Watchlist 1' : 'Watchlist 2'}`);
      openAddToWatchlistModal(symbol); // Refresh the modal
    }
  }
}

// Add to Custom Watchlist
function addToCustomWatchlist(symbol, watchlistId) {
  if (customWatchlists[watchlistId] && !customWatchlists[watchlistId].stocks.includes(symbol)) {
    customWatchlists[watchlistId].stocks.push(symbol);
    showNotification(`‚úÖ ${symbol} added to ${customWatchlists[watchlistId].name}`);
    openAddToWatchlistModal(symbol); // Refresh the modal
  }
}

// Remove from Custom Watchlist
function removeFromCustomWatchlist(symbol, watchlistId) {
  if (customWatchlists[watchlistId]) {
    const idx = customWatchlists[watchlistId].stocks.indexOf(symbol);
    if (idx > -1) {
      customWatchlists[watchlistId].stocks.splice(idx, 1);
      showNotification(`üóëÔ∏è ${symbol} removed from ${customWatchlists[watchlistId].name}`);
      openAddToWatchlistModal(symbol); // Refresh the modal
    }
  }
}

// Show Notification
function showNotification(message) {
  const notification = document.createElement('div');
  notification.style.cssText = `
    position: fixed;
    top: 80px;
    right: 20px;
    background: var(--bg-card);
    color: var(--text-primary);
    padding: 16px 24px;
    border-radius: 12px;
    border: 2px solid var(--color-primary);
    box-shadow: var(--shadow-lg);
    z-index: 3000;
    animation: slideInRight 0.3s ease;
    font-weight: 600;
    max-width: 300px;
  `;
  notification.innerText = message;
  
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOutRight 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Add CSS for notification animations
const style = document.createElement('style');
style.textContent = `
  @keyframes slideInRight {
    from { transform: translateX(400px); opacity: 0; }
    to { transform: translateX(0); opacity: 1; }
  }
  @keyframes slideOutRight {
    from { transform: translateX(0); opacity: 1; }
    to { transform: translateX(400px); opacity: 0; }
  }
`;
document.head.appendChild(style);

// Apply Filters
function applyFilters() {
  let filtered = [...sheetData];
  
  // Search filter
  const searchTerm = document.getElementById('searchInput').value.toLowerCase().trim();
  if (searchTerm) {
    filtered = filtered.filter(r => {
      const symbol = (r["Symbol"] || "").toLowerCase();
      const company = (r["Company Name"] || "").toLowerCase();
      return symbol.includes(searchTerm) || company.includes(searchTerm);
    });
  }
  
  // Watchlist filter
  if (currentWatchlist === 'favorites') {
    filtered = filtered.filter(r => favorites.includes(r["Symbol"]));
  } else if (currentWatchlist === 'watchlist1' || currentWatchlist === 'watchlist2') {
    filtered = filtered.filter(r => watchlists[currentWatchlist].includes(r["Symbol"]));
  } else if (currentWatchlist.startsWith('custom_')) {
    // Custom watchlist
    if (customWatchlists[currentWatchlist]) {
      filtered = filtered.filter(r => customWatchlists[currentWatchlist].stocks.includes(r["Symbol"]));
    }
  }
  
  // Sector filter
  const sector = document.getElementById('sectorFilter').value;
  if (sector !== "ALL") {
    filtered = filtered.filter(r => r["Sector"] === sector);
  }
  
  // Status filter
  const status = document.getElementById('statusFilter').value;
  if (status !== "ALL") {
    filtered = filtered.filter(r => r["PDH/PDL"] === status);
  }
  
  // Percent filter
  const percent = document.getElementById('percentFilter').value;
  if (percent === "POS") {
    filtered = filtered.filter(r => r["PDH/PDL"] === "PDH" && parseFloat(r["Changepct"]) > 0);
  } else if (percent === "NEG") {
    filtered = filtered.filter(r => r["PDH/PDL"] === "PDL" && parseFloat(r["Changepct"]) < 0);
  }
  
  // Volume filter
  const volume = document.getElementById('volumeFilter').value;
  if (volume === "HIGH") {
    const validVol = sheetData.filter(r => r["Volume"] && !isNaN(parseFloat(r["Volume"])));
    const avgVol = validVol.reduce((sum, r) => sum + parseFloat(r["Volume"]), 0) / validVol.length;
    filtered = filtered.filter(r => parseFloat(r["Volume"]) > avgVol);
  }
  
  currentFiltered = filtered;
  renderTable(filtered);
}

// Sort Table
function sortTable() {
  sortOrder = sortOrder === "desc" ? "asc" : "desc";
  currentFiltered.sort((a, b) => {
    const aVal = parseFloat(a["Changepct"]) || 0;
    const bVal = parseFloat(b["Changepct"]) || 0;
    return sortOrder === "desc" ? bVal - aVal : aVal - bVal;
  });
  renderTable(currentFiltered);
}

// Render Table
function renderTable(rows) {
  const tbody = document.getElementById('tableBody');
  
  if (rows.length === 0) {
    tbody.innerHTML = '<tr><td colspan="13" style="text-align:center; padding: 40px; color: var(--text-muted)">No stocks found matching your filters</td></tr>';
    return;
  }
  
  tbody.innerHTML = rows.slice(0, 100).map(r => {
    const status = r["PDH/PDL"];
    const rowClass = status === "PDH" ? "row-pdh" : status === "PDL" ? "row-pdl" : "row-range";
    
    const change = parseFloat(r["Changepct"]);
    const changeText = isNaN(change) ? "-" : r["Changepct"];
    const changeClass = isNaN(change) ? "" : change >= 0 ? "positive" : "negative";
    
    let momentum = "‚û°Ô∏è";
    if (!isNaN(change)) {
      if (change > 3) momentum = "üöÄ";
      else if (change > 1) momentum = "üìà";
      else if (change < -3) momentum = "üí•";
      else if (change < -1) momentum = "üìâ";
    }
    
    const volume = parseFloat(r["Volume"]) || 0;
    const volumeText = volume > 0 
      ? volume >= 1000000 ? (volume/1000000).toFixed(2) + "M" : (volume/1000).toFixed(0) + "K"
      : "-";
    
    const isFav = favorites.includes(r["Symbol"]);
    
    const prices = [
      parseFloat(r["Previous Close"]) || 0,
      parseFloat(r["LTP"]) || 0,
      parseFloat(r["Previous High"]) || 0,
      parseFloat(r["Previous Low"]) || 0
    ];
    
    return `
      <tr class="${rowClass}">
        <td style="text-align: center;">
          <button class="star-btn" onclick="toggleFavorite('${r["Symbol"]}')">${isFav ? '‚≠ê' : '‚òÜ'}</button>
        </td>
        <td style="text-align: center;">
          <a href="https://www.tradingview.com/chart/?symbol=NSE:${r["Symbol"]}" target="_blank" class="symbol-link">${r["Symbol"]}</a>
        </td>
        <td style="text-align: left; padding-left: 16px;">
          <div style="display: flex; align-items: center; gap: 8px;">
            <span>${r["Company Name"] || "-"}</span>
            <button 
              onclick="openAddToWatchlistModal('${r["Symbol"]}')" 
              style="background: var(--color-primary); color: white; border: none; padding: 4px 8px; border-radius: 6px; font-size: 11px; cursor: pointer; font-weight: 600;"
              title="Add to watchlist">
              +
            </button>
          </div>
        </td>
        <td style="text-align: center;">${r["Sector"] || "-"}</td>
        <td style="text-align: center; font-weight: 600;">${r["LTP"] || "-"}</td>
        <td style="text-align: center;">${r["Previous Close"] || "-"}</td>
        <td style="text-align: center;">${r["Previous High"] || "-"}</td>
        <td style="text-align: center;">${r["Previous Low"] || "-"}</td>
        <td style="text-align: center; font-weight: 700;">${status || "-"}</td>
        <td style="text-align: center;">${volumeText}</td>
        <td style="text-align: center;" class="${changeClass}">${changeText}%</td>
        <td style="text-align: center;">${generateMiniChart(prices)}</td>
        <td style="text-align: center; font-size: 20px">${momentum}</td>
      </tr>
    `;
  }).join('');
}

// Generate Mini Chart
function generateMiniChart(prices) {
  const max = Math.max(...prices);
  const min = Math.min(...prices);
  const range = max - min || 1;
  
  const points = prices.map((p, i) => {
    const x = (i / (prices.length - 1)) * 70 + 5;
    const y = 25 - ((p - min) / range) * 20;
    return `${x},${y}`;
  }).join(' ');
  
  const color = prices[prices.length - 1] > prices[0] ? 'var(--color-success)' : 'var(--color-danger)';
  
  return `<svg class="mini-chart" viewBox="0 0 80 30">
    <polyline points="${points}" fill="none" stroke="${color}" stroke-width="2"/>
  </svg>`;
}

// Download CSV
function downloadCSV() {
  if (currentFiltered.length === 0) {
    alert("No data to export");
    return;
  }
  
  const headers = ['Symbol', 'Company', 'Sector', 'LTP', 'Status', 'Change%', 'Volume'];
  const rows = currentFiltered.map(r => [
    r["Symbol"],
    r["Company Name"],
    r["Sector"],
    r["LTP"],
    r["PDH/PDL"],
    r["Changepct"],
    r["Volume"]
  ]);
  
  const csv = [headers, ...rows].map(row => row.join(',')).join('\n');
  const blob = new Blob([csv], { type: 'text/csv' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `watchlist_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
}

// Generate PDF
function generatePDF() {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  
  doc.setFontSize(20);
  doc.text('AshishTrader Breakout Radar Pro', 14, 20);
  
  doc.setFontSize(12);
  doc.text(`Report Date: ${new Date().toLocaleDateString()}`, 14, 30);
  
  doc.setFontSize(14);
  doc.text('Market Summary', 14, 45);
  
  doc.setFontSize(10);
  doc.text(`Total Stocks: ${document.getElementById('totalScanned').innerText}`, 14, 55);
  doc.text(`Advances: ${document.getElementById('advances').innerText}`, 14, 61);
  doc.text(`Declines: ${document.getElementById('declines').innerText}`, 14, 67);
  doc.text(`PDH Breakouts: ${document.getElementById('pdhCount').innerText}`, 14, 73);
  doc.text(`PDL Breakdowns: ${document.getElementById('pdlCount').innerText}`, 14, 79);
  doc.text(`Market Mood: ${document.getElementById('marketMood').innerText}`, 14, 85);
  
  const tableData = currentFiltered.slice(0, 40).map(r => [
    r["Symbol"],
    r["Company Name"]?.substring(0, 25),
    r["Sector"]?.substring(0, 15),
    r["LTP"],
    r["PDH/PDL"],
    r["Changepct"] + '%'
  ]);
  
  doc.autoTable({
    head: [['Symbol', 'Company', 'Sector', 'LTP', 'Status', 'Change%']],
    body: tableData,
    startY: 95,
    styles: { fontSize: 8 }
  });
  
  doc.save(`market_report_${new Date().toISOString().split('T')[0]}.pdf`);
}

// Refresh Data
function refreshData() {
  fetchData();
}

// Auto Refresh
document.getElementById('autoRefresh').addEventListener('change', (e) => {
  if (e.target.checked) {
    refreshInterval = setInterval(() => fetchData(), 60000);
  } else {
    clearInterval(refreshInterval);
  }
});

// Event Listeners
document.getElementById('sectorFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('percentFilter').addEventListener('change', applyFilters);
document.getElementById('volumeFilter').addEventListener('change', applyFilters);

// Debounced search
let searchTimeout;
document.getElementById('searchInput').addEventListener('input', () => {
  clearTimeout(searchTimeout);
  searchTimeout = setTimeout(applyFilters, 300);
});

// Initialize
fetchData();
</script>

</body>
</html>
  
